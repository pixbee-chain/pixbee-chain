package sidechainproposal

import (
	"math/big"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/log"
	"github.com/ethereum/go-ethereum/params"
)

const (
	ContractName = "SidechainProposal"
	contractCode = `0x6080604052600436106101095760003560e01c80637c5d684311610095578063a5bd5d4611610064578063a5bd5d46146103ee578063be64569214610427578063c967f90f1461043c578063db78dd2814610468578063efd8d8e21461049a57610109565b80637c5d6843146102b95780637db803ec146102e7578063898699a8146102fc5780638f37b53d1461032f57610109565b80633a061bd3116100dc5780633a061bd3146101c85780633af8a2bc146101dd5780634c00a969146102945780636233be5d1461029c5780636dba795f146102b157610109565b8063139c472c1461010e5780631543b31314610163578063158ef93e1461018a5780631b5e358c146101b3575b600080fd5b34801561011a57600080fd5b506101476004803603604081101561013157600080fd5b506001600160a01b0381351690602001356104af565b604080516001600160a01b039092168252519081900360200190f35b34801561016f57600080fd5b506101786104e4565b60408051918252519081900360200190f35b34801561019657600080fd5b5061019f6104ea565b604080519115158252519081900360200190f35b3480156101bf57600080fd5b506101476104f3565b3480156101d457600080fd5b506101476104f9565b3480156101e957600080fd5b506102076004803603602081101561020057600080fd5b50356104ff565b6040518085815260200184815260200180602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561025657818101518382015260200161023e565b50505050905090810190601f1680156102835780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b61019f6105ae565b3480156102a857600080fd5b506101476109df565b61019f6109e5565b3480156102c557600080fd5b506102ce610f5f565b6040805192835260208301919091528051918290030190f35b3480156102f357600080fd5b50610178610f69565b34801561030857600080fd5b506102076004803603602081101561031f57600080fd5b50356001600160a01b0316610f6f565b34801561033b57600080fd5b5061019f6004803603606081101561035257600080fd5b81359160208101359181019060608101604082013564010000000081111561037957600080fd5b82018360208201111561038b57600080fd5b803590602001918460018302840111640100000000831117156103ad57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610fe3945050505050565b3480156103fa57600080fd5b506101476004803603604081101561041157600080fd5b506001600160a01b038135169060200135611219565b34801561043357600080fd5b50610178611232565b34801561044857600080fd5b5061045161123f565b6040805161ffff9092168252519081900360200190f35b34801561047457600080fd5b5061047d611244565b6040805167ffffffffffffffff9092168252519081900360200190f35b3480156104a657600080fd5b5061047d61124b565b600460205281600052604060002081815481106104c857fe5b6000918252602090912001546001600160a01b03169150829050565b60015481565b60005460ff1681565b61f00181565b61f00081565b60066020908152600091825260409182902080546001808301546002808501805488519481161561010002600019011691909104601f81018790048702840187019097528683529295909491929183018282801561059e5780601f106105735761010080835404028352916020019161059e565b820191906000526020600020905b81548152906001019060200180831161058157829003601f168201915b5050505050908060030154905084565b60408051631015428760e21b8152336004820152905160009161f000916340550a1c91602480820192602092909190829003018186803b1580156105f157600080fd5b505afa158015610605573d6000803e3d6000fd5b505050506040513d602081101561061b57600080fd5b50516106585760405162461bcd60e51b81526004018080602001828103825260378152602001806113d16037913960400191505060405180910390fd5b3060009081526003602081905260409091200154600a146106aa5760405162461bcd60e51b81526004018080602001828103825260388152602001806114086038913960400191505060405180910390fd5b3060009081526005602090815260409182902080548351818402810184019094528084526060939283018282801561070b57602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116106ed575b505050505090506000808251905060005b8181101561082a57336001600160a01b031684828151811061073a57fe5b60200260200101516001600160a01b031614156107885760405162461bcd60e51b81526004018080602001828103825260298152602001806113726029913960400191505060405180910390fd5b61f0006001600160a01b03166340550a1c8583815181106107a557fe5b60200260200101516040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b1580156107ea57600080fd5b505afa1580156107fe573d6000803e3d6000fd5b505050506040513d602081101561081457600080fd5b505115610822576001909201915b60010161071c565b5030600090815260056020908152604080832080546001818101835591855292842090920180546001600160a01b0319163317905580516313bce04b60e31b81529051949091019361f00091639de702589160048083019286929190829003018186803b15801561089a57600080fd5b505afa1580156108ae573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405260208110156108d757600080fd5b81019080805160405193929190846401000000008211156108f757600080fd5b90830190602082018581111561090c57600080fd5b825186602082028301116401000000008211171561092957600080fd5b82525081516020918201928201910280838360005b8381101561095657818101518382015260200161093e565b5050505090500160405250505051905080604b028360640211156109d457306000908152600360205260408120818155600181018290559061099b6002830182611251565b5060006003919091018190553081526004602052604081206109bc91611298565b3060009081526005602052604081206109d491611298565b600194505050505090565b61f00281565b60408051631015428760e21b8152336004820152905160009161f000916340550a1c91602480820192602092909190829003018186803b158015610a2857600080fd5b505afa158015610a3c573d6000803e3d6000fd5b505050506040513d6020811015610a5257600080fd5b5051610a8f5760405162461bcd60e51b81526004018080602001828103825260378152602001806114406037913960400191505060405180910390fd5b3060009081526003602081905260409091200154600a14610ae15760405162461bcd60e51b81526004018080602001828103825260388152602001806114086038913960400191505060405180910390fd5b30600090815260046020908152604091829020805483518184028101840190945280845260609392830182828015610b4257602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610b24575b505050505090506000808251905060005b81811015610c6157336001600160a01b0316848281518110610b7157fe5b60200260200101516001600160a01b03161415610bbf5760405162461bcd60e51b81526004018080602001828103825260298152602001806113726029913960400191505060405180910390fd5b61f0006001600160a01b03166340550a1c858381518110610bdc57fe5b60200260200101516040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b158015610c2157600080fd5b505afa158015610c35573d6000803e3d6000fd5b505050506040513d6020811015610c4b57600080fd5b505115610c59576001909201915b600101610b53565b5030600090815260046020818152604080842080546001818101835591865292852090920180546001600160a01b0319163317905580516313bce04b60e31b81529051959091019461f00092639de70258928082019286929091829003018186803b158015610ccf57600080fd5b505afa158015610ce3573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f191682016040526020811015610d0c57600080fd5b8101908080516040519392919084640100000000821115610d2c57600080fd5b908301906020820185811115610d4157600080fd5b8251866020820283011164010000000082111715610d5e57600080fd5b82525081516020918201928201910280838360005b83811015610d8b578181015183820152602001610d73565b5050505090500160405250505051905080604b028360640211156109d457610db16112b6565b30600090815260036020908152604091829020825160808101845281548152600180830154828501526002808401805487519381161561010002600019011691909104601f81018690048602830186018752808352929593949386019391929091830182828015610e635780601f10610e3857610100808354040283529160200191610e63565b820191906000526020600020905b815481529060010190602001808311610e4657829003601f168201915b50505091835250506003919091015460209182015281516002908155828201805160019081556040805160808101825286518152925183860190815281870151848301908152600b60608601528751600090815260068852929092208451815590519281019290925551805195965091949093610ee49385019201906112de565b5060609190910151600391820155306000908152602091909152604081208181556001810182905590610f1a6002830182611251565b506000600391909101819055308152600460205260408120610f3b91611298565b306000908152600560205260408120610f5391611298565b50600194505050505090565b6002546001549091565b60025481565b60036020908152600091825260409182902080546001808301546002808501805488519481161561010002600019011691909104601f81018790048702840187019097528683529295909491929183018282801561059e5780601f106105735761010080835404028352916020019161059e565b60408051631015428760e21b8152336004820152905160009161f000916340550a1c91602480820192602092909190829003018186803b15801561102657600080fd5b505afa15801561103a573d6000803e3d6000fd5b505050506040513d602081101561105057600080fd5b505161108d5760405162461bcd60e51b81526004018080602001828103825260378152602001806114406037913960400191505060405180910390fd5b600084116110cc5760405162461bcd60e51b81526004018080602001828103825260438152602001806114e26043913960600191505060405180910390fd5b6000831161110b5760405162461bcd60e51b81526004018080602001828103825260368152602001806114776036913960400191505060405180910390fd5b3060009081526003602081905260409091200154600a141561115e5760405162461bcd60e51b815260040180806020018281038252603681526020018061139b6036913960400191505060405180910390fd5b600084815260066020526040902060030154600b14156111af5760405162461bcd60e51b81526004018080602001828103825260358152602001806114ad6035913960400191505060405180910390fd5b604080516080810182528581526020808201868152828401868152600a6060850152306000908152600384529490942083518155905160018201559251805192939261120192600285019201906112de565b50606091909101516003909101555060019392505050565b600560205281600052604060002081815481106104c857fe5b6801bc16d674ec80000081565b601581565b6201518081565b61708081565b50805460018160011615610100020316600290046000825580601f106112775750611295565b601f016020900490600052602060002090810190611295919061135c565b50565b5080546000825590600052602060002090810190611295919061135c565b6040518060800160405280600081526020016000815260200160608152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061131f57805160ff191683800117855561134c565b8280016001018555821561134c579182015b8281111561134c578251825591602001919060010190611331565b5061135892915061135c565b5090565b5b80821115611358576000815560010161135d56fe53696465636861696e50726f706f73616c3a205468652061646472657373206861766520766f74656453696465636861696e50726f706f73616c3a2043757272656e74206861642061206d6f64696679207265636f726420746f20766f746553696465636861696e50726f706f73616c3a205468652076616c696461746f72206973206e6f74206578697374206f722061637469766553696465636861696e50726f706f73616c3a20546865726520686173206e6f742061206d6f64696679207265636f726420746f20766f746553696465636861696e50726f706f73616c3a205468652056616c696461746f72206973206e6f74206578697374206f722061637469766553696465636861696e50726f706f73616c3a2054686520617267756d656e74206d7573742067726561746572207468616e207a65726f53696465636861696e50726f706f73616c3a205468652073696465636861696e20626c6f636b6e756d62657220697320657869737453696465636861696e50726f706f73616c3a205468652073696465636861696e20626c6f636b6e756d626572206d7573742067726561746572207468616e207a65726fa26469706673582212205dcac3878d2caa9397efd6c5e79e37af354c70742c533fcec5e8d57066c179e564736f6c634300060c0033`
)

var (
	ContractAddr = common.HexToAddress("0x000000000000000000000000000000000000C010")
)

type SidechainProposal struct {
}

func (s *SidechainProposal) GetName() string {
	return ContractName
}

func (s *SidechainProposal) Upgrade(config *params.ChainConfig, height *big.Int, state *state.StateDB) (err error) {
	code := common.FromHex(contractCode)

	// Set new version system contract to state db
	state.SetCode(ContractAddr, code)

	log.Info("Write code to system contract account", "addr", ContractAddr.String(), "code", contractCode)

	return
}

// Init transaction when upgrade system contract
func (s *SidechainProposal) Init(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	return nil
}

// Execute transaction when upgrade system contract
func (s *SidechainProposal) Execute(state *state.StateDB, header *types.Header, chainContext core.ChainContext, config *params.ChainConfig) (err error) {
	return nil
}
